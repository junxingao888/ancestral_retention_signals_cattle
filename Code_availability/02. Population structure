#!/bin/bash
#SBATCH --job-name=pop_structure
#SBATCH --cpus-per-task=8
#SBATCH --mem=32G

# ============================
# User settings
# ============================
file=636_samples.vcf.gz
prefix=$(basename $file .vcf.gz)

module load plink/1.9
module load vcftools
module load admixture/1.3.0

# ============================
# 1. Convert VCF â†’ PLINK (with QC)
# ============================
plink \
  --vcf $file \
  --make-bed \
  --maf 0.01 \
  --geno 0.01 \
  --double-id \
  --allow-extra-chr \
  --chr-set 30 \
  --threads 8 \
  --out ${prefix}

# ============================
# 2. LD pruning (--indep-pairwise 50 10 0.2)
# ============================
plink \
  --bfile ${prefix} \
  --indep-pairwise 50 10 0.2 \
  --threads 8 \
  --allow-extra-chr \
  --chr-set 30 \
  --out ${prefix}.pruned

# Extract pruned SNPs
plink \
  --bfile ${prefix} \
  --extract ${prefix}.pruned.prune.in \
  --make-bed \
  --allow-extra-chr \
  --chr-set 30 \
  --threads 8 \
  --out ${prefix}.LDpruned

# ============================
# 3. IBD estimation (PI_HAT)
# ============================
plink \
  --bfile ${prefix}.LDpruned \
  --genome \
  --min 0 \
  --allow-extra-chr \
  --chr-set 30 \
  --threads 8 \
  --out ${prefix}.IBD

# Output: ${prefix}.IBD.genome (contains PI_HAT)

# ============================
# 4. PCA (top 4 PCs)
# ============================
plink \
  --bfile ${prefix}.LDpruned \
  --pca 4 \
  --allow-extra-chr \
  --chr-set 30 \
  --threads 8 \
  --out ${prefix}.PCA

# Output: ${prefix}.PCA.eigenvec

# ============================
# 5. IBS distance matrix + NJ tree
# ============================
plink \
  --bfile ${prefix}.LDpruned \
  --distance square 1-ibs \
  --allow-extra-chr \
  --chr-set 30 \
  --threads 8 \
  --out ${prefix}.IBS

# R code for NJ tree:
# library(ape)
# ibs <- as.matrix(read.table("${prefix}.IBS.mdist"))
# nj_tree <- nj(as.dist(ibs))
# write.tree(nj_tree, file="NJ_tree.newick")

# ============================
# 6. ADMIXTURE (K=1..8)
# ============================
# ADMIXTURE requires chromosome code "0"
awk '{ $1=0; print $0 }' ${prefix}.LDpruned.bim > tmp.bim
mv tmp.bim ${prefix}.LDpruned.bim

for K in {1..8}; do
    admixture --cv ${prefix}.LDpruned.bed $K | tee log${K}.out
done

grep CV log*.out > cv_summary.txt

# ============================
# 7. Genome-wide Fst via VCFtools
# ============================
# Requires two population files: pop1.txt pop2.txt

vcftools \
  --gzvcf $file \
  --weir-fst-pop pop1.txt \
  --weir-fst-pop pop2.txt \
  --fst-window-size 50000 \
  --fst-window-step 25000 \
  --out ${prefix}.FST

